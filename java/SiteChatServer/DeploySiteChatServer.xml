<project name="deploy site chat server" default="build" basedir=".">

	<property name="checkout-root" value="./SiteChatServer"/>
	<property name="checkout-lib" value="${checkout-root}/lib"/>
	<property name="checkout-src" value="${checkout-root}/src"/>
	<property name="checkout-classes" value="${checkout-root}/classes"/>
	<property name="checkout-resources" value="${checkout-root}/resources"/>
	<property name="sitechat-root" value=""/>
	<property name="branch" value="trunk" />
	<property name="revision" value="" />

	<property name="branch" value="trunk" />
	<property name="revision" value="" />

	<path id="classpath">
		<fileset dir="${checkout-lib}">
			<include name="**/*.jar"/>
		</fileset>
	</path>

	<target name="build">
		<antcall target="svn-cleanup"/>
		<antcall target="svn-checkout"/>
		<antcall target="compile"/>
		<antcall target="shutdown-server"/>
		<antcall target="inject-updates"/>
		<antcall target="start-server"/>
		<antcall target="svn-cleanup"/>
	</target>

	<target name="svn-cleanup">
		<delete dir="${checkout-root}" />
    </target>

	<target name="svn-checkout">
		<echo>SVN Checkout. Root: ${checkout-root} SRC: ${checkout-src}</echo>
		<exec dir="." executable="git">
			<arg line="-C git-repo pull" />
		</exec>
		<copydir src="./git-repo/java/SiteChatServer" dest="${checkout-root}"/>
	</target>
	
	<target name="shutdown-server">
		<echo>Shutting Server...</echo>
		<exec executable="bash" newenvironment="false" dir=".">
			<arg line="StopProdSiteChatServer"/>
		</exec>
	</target>
		
	<target name="start-server">
		<echo>Starting Server...</echo>
		<exec executable="bash" newenvironment="false" dir=".">
			<arg line="StartProdSiteChatServer"/>
		</exec>
	</target>
	
	<target name="inject-updates">
		<copy todir="${sitechat-root}/lib" flatten="true">
			<fileset dir="${checkout-lib}">
				<include name="**/*.jar"/>
			</fileset>
		</copy>
	</target>

	<target name="compile">

		<delete dir="${checkout-classes}" failonerror="false"/>
		<mkdir dir="${checkout-classes}"/>

		<javac executable="/usr/bin/javac" fork="true" srcdir="${checkout-src}" destdir="${checkout-classes}" debug="true" classpathref="classpath">
			<include name="**/*.java"/>
		</javac>

		<jar destfile="${checkout-lib}/site-chat-server.jar">
			<fileset dir="${checkout-classes}" />
			<fileset dir="${checkout-resources}" />
		</jar>

	</target>
</project>
